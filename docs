# Catci Login – Integration Guide

Catci provides an OAuth 2.0 compliant login service that other sites can use to authenticate users.  
All endpoints below are hosted at **http://localhost:4000**.

---

## 1. Authorize the User

Redirect the user’s browser to:

```
http://localhost:4000/oauth/authorize?client_id=YOUR_CLIENT_ID&redirect_uri=YOUR_REDIRECT_URI&response_type=code&state=YOUR_STATE&code_challenge=YOUR_CHALLENGE
```

Parameters:

| Name | Required | Description |
|------|-----------|-------------|
| client_id | ✓ | Your app’s ID as registered in `clients.json` |
| redirect_uri | ✓ | Must match a URI in your registered client entry |
| response_type | ✓ | Must be `code` |
| state | optional | Any value you want returned for request tracking |
| code_challenge | optional | PKCE challenge (base64url encoded SHA‑256 of a verifier) |

If the user is not logged in, they’ll be asked to log in.  
Then they will see a consent page and, when allowed, will be redirected to your site:

```
YOUR_REDIRECT_URI?code=AUTH_CODE&state=YOUR_STATE
```

---

## 2. Exchange Code for Access Token

Your backend should POST to:

```
POST http://localhost:4000/api/oauth/token
Content-Type: application/json
```

Body:

```json
{
  "client_id": "YOUR_CLIENT_ID",
  "client_secret": "YOUR_CLIENT_SECRET",
  "code": "AUTH_CODE",
  "code_verifier": "YOUR_VERIFIER_IF_USING_PKCE"
}
```

Response:

```json
{
  "access_token": "JWT_TOKEN_HERE",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

Store this token securely; it represents the logged‑in user.

---

## 3. Get User Information

Use the access token to fetch account information:

```
GET http://localhost:4000/api/oauth/user
Authorization: Bearer ACCESS_TOKEN
```

Response:

```json
{
  "username": "exampleuser",
  "email": "user@example.com",
  "issuer": "catci.net"
}
```

---

## 4. Logging Out

To log out the user from Catci:

```
POST http://localhost:4000/api/logout
```

This removes the Catci session cookie, but you can still revoke local sessions independently.

---

## 5. Example Flow Summary

1. Redirect user to `/oauth/authorize`  
2. Receive `code` at your redirect URI  
3. Exchange `code` for a token via `/api/oauth/token`  
4. Call `/api/oauth/user` with that token to identify the user  
5. Create or look up a local user account in your application

---

## Notes

- Tokens are RSA‑signed JWTs (`RS256`).
- Public JWKs for verification are at `/jwks.json`.
- Access tokens last 1 hour; refresh by repeating the flow.
- Always perform the code exchange on your backend server—never on the client side.

---