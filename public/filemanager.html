<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>File Manager</title>
    <style>
      :root {
        --yellow: #fadc79;
        --yellow-dark: #e9be11;
        --black: #1d1c15;
        --deep-black: #12110a;
        --white: #f0ede2;
      }

      body {
        font-family: 'Jetbrains Mono', monospace, Arial, sans-serif;
        max-width: 1000px;
        margin: 28px auto;
        padding: 20px;
        color: var(--white);
        background-image: repeating-conic-gradient(var(--black) 0% 25%, var(--deep-black) 0% 50%);
        background-size: 8px 8px;
        box-sizing: border-box;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      h2#username { color: var(--yellow); margin: 0; }

      #storage { font-size: 0.9em; color: rgba(240,237,226,0.8); }

      #breadcrumb a { text-decoration: none; color: var(--yellow-dark); }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1em;
        background: transparent;
      }

      th, td {
        border-bottom: 1px solid rgba(255,255,255,0.04);
        padding: 10px 12px;
        text-align: left;
      }

      th { color: var(--yellow); font-weight: 700; }

      tr:hover { background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }

      #uploadBtn, #newFolderBtn {
        background: var(--yellow);
        color: var(--black);
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 6px;
        font-weight: 700;
      }

      #uploadBtn:hover, #newFolderBtn:hover { background: var(--yellow-dark); }

      #logout { text-decoration: none; color: #ff6b6b; margin-left: 6px; }

      input[type="file"] { display: none; }

      .renameBtn {
        background: rgba(250,220,121,0.12);
        color: var(--yellow);
        padding: 6px 10px;
        border: 1px solid rgba(250,220,121,0.18);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
      }

      .renameBtn:hover { background: rgba(250,220,121,0.2); }

      .deleteBtn {
        background: rgba(255,107,107,0.12);
        color: #ff6b6b;
        padding: 6px 10px;
        border: 1px solid rgba(255,107,107,0.18);
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        margin-left: 6px;
      }

      .deleteBtn:hover { background: rgba(255,107,107,0.2); }

      .urlsContainer {
        font-size: 0.8em;
        color: rgba(240,237,226,0.6);
        margin-top: 4px;
        padding: 6px;
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
      }

      .urlRow {
        margin: 3px 0;
        font-family: 'Courier New', monospace;
        word-break: break-all;
      }

      .urlLabel {
        color: rgba(250,220,121,0.7);
        margin-right: 4px;
      }

      /* Small screens */
      @media (max-width: 700px) {
        body { padding: 12px; margin: 12px; }
        header { flex-direction: column; align-items: flex-start; gap: 8px; }
        table { font-size: 14px; }
        th, td { padding: 8px; }
      }
    </style>
  </head>
  <body>
    <header>
      <h2 id="username">File Manager</h2>
      <div>
        <label for="fileInput" id="uploadBtn">Upload</label>
        <input id="fileInput" type="file" />
        <button id="newFolderBtn">+ Folder</button>
        <a id="logout" href="/logout">Logout</a>
      </div>
    </header>
    <div id="storage"></div>
    <div id="breadcrumb"></div>

    <table id="fileTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Size</th>
          <th>Modified</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      let currentPath = "";

      function bytesToMB(b) {
        return (b / 1e6).toFixed(2) + " MB";
      }

      async function fetchFiles() {
        const res = await fetch("/api/files?path=" + encodeURIComponent(currentPath));
        if (!res.ok) {
          document.body.innerHTML = "<p>Session expired. <a href='/'>Login again</a>.</p>";
          return;
        }
        const data = await res.json();
        const tbody = document.querySelector("#fileTable tbody");
        tbody.innerHTML = "";
        document.querySelector("#username").textContent = `${data.username}'s Files`;

        const percent = ((data.usedBytes / data.maxBytes) * 100).toFixed(1);
        document.querySelector(
          "#storage"
        ).textContent = `Used ${bytesToMB(data.usedBytes)} / ${bytesToMB(
          data.maxBytes
        )} (${percent}%)`;
        const bc = ["<a href='#' data-path=''>Home</a>"];
        const parts = currentPath.split("/").filter(Boolean);
        let walk = "";
        for (const p of parts) {
          walk += (walk ? "/" : "") + p;
          bc.push(`<a href='#' data-path='${walk}'>${p}</a>`);
        }
        document.querySelector("#breadcrumb").innerHTML = bc.join(" / ");

        if (data.items.length === 0) {
          tbody.innerHTML = "<tr><td colspan='4'>(empty)</td></tr>";
        } else {
          for (const item of data.items) {
            const tr = document.createElement("tr");
            const date = new Date(item.mtime).toLocaleString();
            if (item.isDir) {
              tr.innerHTML = `<td><a href='#' data-dir='${item.path}'>üìÅ ${
                item.name
              }</a></td><td>-</td><td>${date}</td><td><button class='renameBtn' data-path='${item.path}' data-name='${item.name}'>Rename</button><button class='deleteBtn' data-path='${item.path}'>Delete</button></td>`;
            } else {
              const timestamp = item.name;
              const original = item.originalName;
              const slug = item.slug;
              const username = data.username;
              
              let urlsHtml = '';
              if (slug) {
                urlsHtml = `
                  <div class="urlsContainer">
                    <div class="urlRow"><span class="urlLabel">Short:</span>/files/${username}/${slug}</div>
                    <div class="urlRow"><span class="urlLabel">Pretty:</span>/files/${username}/${original}</div>
                    <div class="urlRow"><span class="urlLabel">Timestamp:</span>/files/${username}/${timestamp}</div>
                  </div>
                `;
              } else {
                urlsHtml = `
                  <div class="urlsContainer">
                    <div class="urlRow"><span class="urlLabel">URL:</span>/files/${username}/${original}</div>
                  </div>
                `;
              }
              
              tr.innerHTML = `<td><a href='${item.url}' target='_blank'>${item.name}</a>${urlsHtml}</td><td>${bytesToMB(
                item.size
              )}</td><td>${date}</td><td><button class='renameBtn' data-path='${item.path}' data-name='${item.name}'>Rename</button><button class='deleteBtn' data-path='${item.path}'>Delete</button></td>`;
            }
            tbody.appendChild(tr);
          }
        }
      }

      document.getElementById("breadcrumb").addEventListener("click", (e) => {
        if (e.target.dataset.path !== undefined) {
          e.preventDefault();
          currentPath = e.target.dataset.path;
          fetchFiles();
        }
      });

      document.querySelector("#fileTable").addEventListener("click", (e) => {
        if (e.target.dataset.dir !== undefined) {
          e.preventDefault();
          currentPath = e.target.dataset.dir;
          fetchFiles();
        }
      });

      document.querySelector("#fileInput").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const form = new FormData();
        form.append("file", file);
        const res = await fetch("/api/upload?path=" + encodeURIComponent(currentPath), {
          method: "POST",
          body: form,
        });
        if (!res.ok) {
          const err = await res.json();
          alert(err.error);
        }
        e.target.value = "";
        fetchFiles();
      });

      document.getElementById("newFolderBtn").addEventListener("click", async () => {
        const name = prompt("Folder name:");
        if (!name) return;
        await fetch("/api/folder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path: currentPath, name }),
        });
        fetchFiles();
      });

      document.querySelector("#fileTable").addEventListener("click", async (e) => {
        if (e.target.classList.contains("renameBtn")) {
          const filePath = e.target.dataset.path;
          const oldName = e.target.dataset.name;
          const newName = prompt("New name:", oldName);
          if (!newName || newName === oldName) return;
          const res = await fetch("/api/rename", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path: filePath, newName }),
          });
          if (!res.ok) {
            const err = await res.json();
            alert(err.error);
          }
          fetchFiles();
        }
        
        if (e.target.classList.contains("deleteBtn")) {
          const filePath = e.target.dataset.path;
          if (!confirm("Are you sure you want to delete this?")) return;
          const res = await fetch("/api/delete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path: filePath }),
          });
          if (!res.ok) {
            const err = await res.json();
            alert(err.error);
          } else {
            fetchFiles();
          }
        }
      });

      fetchFiles();
    </script>
  </body>
</html>